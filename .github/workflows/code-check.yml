name: Code Quality Check

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

permissions:
  contents: read

jobs:
  check:
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
    
    - name: ‚öôÔ∏è Setup clang-format
      run: sudo apt-get update && sudo apt-get install -y clang-format
    
    - name: üîß Make scripts executable
      run: chmod +x scripts/*.sh
    
    - name: üìù Check formatting
      id: format-check
      run: |
        echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è..."
        if find . -name "*.c" -o -name "*.h" -type f | xargs clang-format --dry-run --Werror 2>/dev/null; then
          echo "‚úÖ –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ"
          echo "result=success" >> $GITHUB_OUTPUT
        else
          echo "‚ùå –û—à–∏–±–∫–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"
          echo "–ó–∞–ø—É—Å—Ç–∏—Ç–µ –ª–æ–∫–∞–ª—å–Ω–æ: make format"
          echo "result=failure" >> $GITHUB_OUTPUT
          exit 1
        fi
    
    - name: üí¨ Check comments
      id: comment-check
      run: |
        echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤..."
        if ./scripts/check_comments.sh; then
          echo "‚úÖ –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã"
          echo "result=success" >> $GITHUB_OUTPUT
        else
          echo "‚ùå –ï—Å—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏ –±–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤"
          echo "result=failure" >> $GITHUB_OUTPUT
          exit 1
        fi
    
    - name: üìä Report results
      if: always()
      run: |
        echo "üìã –ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç:"
        echo "–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: ${{ steps.format-check.outputs.result || '–Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ' }}"
        echo "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏: ${{ steps.comment-check.outputs.result || '–Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ' }}"
        echo ""
        echo "–î–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ª–æ–∫–∞–ª—å–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:"
        echo "  make format  # –∞–≤—Ç–æ—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ"
        echo "  make check   # –ø—Ä–æ–≤–µ—Ä–∫–∞"
