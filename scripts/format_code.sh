#!/bin/bash

echo "üîß –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤..."

# –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ C —Ñ–∞–π–ª—ã
find . -name "*.c" -o -name "*.h" | while read -r file; do
    echo "üìù –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º: $file"
    
    # –í—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
    temp_file=$(mktemp)
    
    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ñ–∞–π–ª
    awk '
    BEGIN {
        in_comment = 0
        need_comment = 0
        last_line_was_empty = 0
        function_start = 0
    }
    
    # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏ –Ω–∞—á–∞–ª–µ —Ñ–∞–π–ª–∞
    FNR == 1 {
        in_comment = 0
        need_comment = 0
        last_line_was_empty = 0
        function_start = 0
    }
    
    # –ú–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
    /\/\*/ { in_comment = 1 }
    /\*\// { in_comment = 0; next }
    
    # –ï—Å–ª–∏ –≤–Ω—É—Ç—Ä–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
    in_comment { print; next }
    
    # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–Ω—ã–µ –¥–∏—Ä–µ–∫—Ç–∏–≤—ã
    /^[[:space:]]*#/ { 
        print
        need_comment = 0
        last_line_was_empty = 0
        next
    }
    
    # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–∫—Ä—ã–≤–∞—é—â–∏–µ —Å–∫–æ–±–∫–∏
    /^[[:space:]]*}/ {
        print
        need_comment = 0
        last_line_was_empty = 0
        next
    }
    
    # –û–±—ä—è–≤–ª–µ–Ω–∏—è —Ç–∏–ø–æ–≤, —Å—Ç—Ä—É–∫—Ç—É—Ä
    /^[[:space:]]*(typedef|struct|union|enum)/ {
        print
        need_comment = 0
        last_line_was_empty = 0
        next
    }
    
    # –ü—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
    /^[[:space:]]*$/ {
        print
        last_line_was_empty = 1
        next
    }
    
    # –û–¥–Ω–æ—Å—Ç—Ä–æ—á–Ω—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
    /^[[:space:]]*\/\// {
        print
        need_comment = 0
        last_line_was_empty = 0
        next
    }
    
    # –ù–∞—à–ª–∏ —Ñ—É–Ω–∫—Ü–∏—é (–Ω–µ –ø—Ä–æ—Ç–æ—Ç–∏–ø)
    /^[[:space:]]*[a-zA-Z_][a-zA-Z0-9_]*[[:space:]]+[a-zA-Z_][a-zA-Z0-9_]*[[:space:]]*\([^)]*\)[[:space:]]*[^{]*$/ && !/;/ {
        if (need_comment == 1 && last_line_was_empty == 1) {
            # –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–º—è —Ñ—É–Ω–∫—Ü–∏–∏
            match($0, /[a-zA-Z_][a-zA-Z0-9_]*[[:space:]]*\(/)
            func_name = substr($0, RSTART, RLENGTH-1)
            gsub(/[[:space:]]+$/, "", func_name)
            
            # –ü–µ—á–∞—Ç–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
            print ""
            print "/**"
            print " * " func_name " - [–ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò–ô –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ô]"
            print " *"
            print " * @brief –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏"
            print " * @details –ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏"
            print " *"
            
            # –ü—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
            if (match($0, /\(([^)]+)\)/, params)) {
                split(params[1], param_list, ",")
                for (i in param_list) {
                    gsub(/^[[:space:]]+/, "", param_list[i])
                    gsub(/[[:space:]]+$/, "", param_list[i])
                    if (param_list[i] != "void" && param_list[i] != "") {
                        print " * @param " param_list[i] " - –æ–ø–∏—Å–∞–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞"
                    }
                }
            }
            
            print " * @return –í–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ"
            print " */"
            
            echo "‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–ª—è: $func_name" >&2
        }
        print
        need_comment = 0
        last_line_was_empty = 0
        next
    }
    
    # –ï—Å–ª–∏ –ø—Ä–µ–¥—ã–¥—É—â–∞—è —Å—Ç—Ä–æ–∫–∞ –±—ã–ª–∞ –ø—É—Å—Ç–æ–π –∏ —ç—Ç–æ –Ω–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
    last_line_was_empty == 1 && !/^[[:space:]]*\/\// {
        need_comment = 1
    }
    
    # –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω–æ–µ
    {
        print
        last_line_was_empty = 0
    }
    ' "$file" > "$temp_file"
    
    # –°–Ω–∞—á–∞–ª–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º clang-format
    clang-format -i "$temp_file"
    
    # –ó–∞–º–µ–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª
    mv "$temp_file" "$file"
    
done

echo "‚úÖ –ê–≤—Ç–æ—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
echo ""
echo "‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –ø–æ–º–µ—á–µ–Ω—ã –∫–∞–∫ [–ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò–ô –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ô]"
echo "   –ó–∞–º–µ–Ω–∏ –∏—Ö –Ω–∞ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—É—é –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –ø–µ—Ä–µ–¥ –∫–æ–º–º–∏—Ç–æ–º!"
