#!/bin/bash

echo "üîß –ê–≤—Ç–æ—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ clang-format..."
find . -name "*.c" -o -name "*.h" | xargs clang-format -i

echo "üìù –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –±–∞–∑–æ–≤—ã—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –∫ —Ñ—É–Ω–∫—Ü–∏—è–º –±–µ–∑ –Ω–∏—Ö..."

# –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
find . -name "*.c" -type f | while read -r file; do
    echo "–û–±—Ä–∞–±–æ—Ç–∫–∞: $file"
    
    # –í—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
    temp_file=$(mktemp)
    
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º sed –¥–ª—è –ø—Ä–æ—Å—Ç–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
    # –ò—â–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –±–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø–µ—Ä–µ–¥ –Ω–∏–º–∏
    line_num=0
    in_comment=0
    
    while IFS= read -r line; do
        ((line_num++))
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
        if [[ $line =~ "/\*" ]]; then
            in_comment=1
        fi
        if [[ $line =~ "\*/" ]]; then
            in_comment=0
        fi
        
        # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –µ—Å–ª–∏ –≤–Ω—É—Ç—Ä–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
        if [[ $in_comment -eq 1 ]]; then
            echo "$line" >> "$temp_file"
            continue
        fi
        
        # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –æ–¥–Ω–æ—Å—Ç—Ä–æ—á–Ω—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
        if [[ $line =~ ^[[:space:]]*// ]]; then
            echo "$line" >> "$temp_file"
            continue
        fi
        
        # –ù–∞—à–ª–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ (—É–ø—Ä–æ—â–µ–Ω–Ω–æ)
        if [[ $line =~ ^[[:space:]]*[a-zA-Z_][a-zA-Z0-9_]*[[:space:]]+[a-zA-Z_][a-zA-Z0-9_]*[[:space:]]*\(.*\)[[:space:]]*\{?[[:space:]]*$ ]] && \
           ! [[ $line =~ ";" ]] && \
           ! [[ $line =~ ^[[:space:]]*(typedef|struct|enum|union) ]]; then
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º 3 –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å—Ç—Ä–æ–∫–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
            has_comment=0
            for ((i=1; i<=3; i++)); do
                prev_line_num=$((line_num - i))
                if [[ $prev_line_num -gt 0 ]]; then
                    prev_line=$(sed -n "${prev_line_num}p" "$file")
                    if [[ $prev_line =~ ^[[:space:]]*(/\*|//) ]]; then
                        has_comment=1
                        break
                    fi
                fi
            done
            
            if [[ $has_comment -eq 0 ]]; then
                # –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–º—è —Ñ—É–Ω–∫—Ü–∏–∏
                if [[ $line =~ ([a-zA-Z_][a-zA-Z0-9_]*)[[:space:]]*\( ]]; then
                    func_name="${BASH_REMATCH[1]}"
                    echo "   –î–æ–±–∞–≤–ª–µ–Ω –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–∏: $func_name"
                    
                    # –î–æ–±–∞–≤–ª—è–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
                    echo "" >> "$temp_file"
                    echo "/*" >> "$temp_file"
                    echo " * $func_name - [–ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò–ô –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ô]" >> "$temp_file"
                    echo " *" >> "$temp_file"
                    echo " * @brief TODO: –¥–æ–±–∞–≤—å –æ–ø–∏—Å–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏" >> "$temp_file"
                    echo " * @return TODO: –æ–ø–∏—à–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ" >> "$temp_file"
                    echo " */" >> "$temp_file"
                fi
            fi
        fi
        
        echo "$line" >> "$temp_file"
    done < "$file"
    
    # –ó–∞–º–µ–Ω—è–µ–º —Ñ–∞–π–ª
    mv "$temp_file" "$file"
done

echo "‚úÖ –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
echo "‚ö†Ô∏è  –ó–∞–º–µ–Ω–∏ [–ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò–ô –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ô] –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ!"
