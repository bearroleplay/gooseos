name: Build GooseOS

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Cache APT
      uses: actions/cache@v3
      with:
        path: /var/cache/apt/archives
        key: ${{ runner.os }}-apt-${{ hashFiles('**/setup.sh') }}
        restore-keys: |
          ${{ runner.os }}-apt-
          
    - name: Install 32-bit toolchain
      run: |
        sudo dpkg --add-architecture i386
        sudo apt-get update
        sudo apt-get install -y \
          nasm \
          gcc-multilib \
          g++-multilib \
          libc6-dev:i386 \
          libc6-dev-i386 \
          lib32gcc-11-dev \
          lib32stdc++6 \
          grub-pc-bin \
          grub-common \
          xorriso \
          mtools \
          qemu-system-x86
        # Проверка установки
        gcc -m32 --version
        ls -la /usr/include/ || true
        ls -la /usr/include/i386-linux-gnu/ || true
          
    - name: Cache build
      uses: actions/cache@v3
      with:
        path: |
          kernel/*.o
          kernel/*.a
        key: ${{ runner.os }}-build-${{ hashFiles('kernel/**/*.c', 'kernel/**/*.h', 'kernel/**/*.asm') }}
        restore-keys: |
          ${{ runner.os }}-build-
          
    - name: Build
      run: |
        make clean
        make -j$(nproc) CFLAGS="-m32 -std=c99 -ffreestanding -O2 -Wall -Wextra -nostdlib -fno-builtin -fno-stack-protector -U_FORTIFY_SOURCE -D_FORTIFY_SOURCE=0 -I/usr/include/i386-linux-gnu"
        
    - name: Create ISO
      run: make gooseos.iso
      
    - name: Upload ISO
      uses: actions/upload-artifact@v4
      with:
        name: gooseos-iso
        path: gooseos.iso
        retention-days: 30
        
    - name: Upload kernel
      uses: actions/upload-artifact@v4
      with:
        name: gooseos-kernel
        path: kernel.bin
        retention-days: 30
